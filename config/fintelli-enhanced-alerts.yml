# Alertas Aprimorados para Fintelli - Sistema Financeiro
# Arquivo: config/fintelli-enhanced-alerts.yml

groups:
  # ==========================================
  # ALERTAS DE NEG√ìCIO ESPEC√çFICOS FINTECH
  # ==========================================
  - name: fintelli-business-alerts
    rules:
      # Alertas relacionados a transa√ß√µes financeiras
      - alert: HighTransactionFailureRate
        expr: |
          (
            increase(transactions_created_total[5m]) == 0 AND
            rate(calls_total{http_route="/api/transactions", http_status_code!="201"}[5m]) > 0
          ) OR (
            (rate(calls_total{http_route="/api/transactions", http_status_code!="201"}[5m]) /
             rate(calls_total{http_route="/api/transactions"}[5m])) * 100 > 5
          )
        for: 2m
        labels:
          severity: critical
          service: fintelli-backend
          category: business
          business_impact: high
        annotations:
          summary: "Taxa alta de falhas em transa√ß√µes financeiras ({{ $value | humanizePercentage }})"
          description: |
            üè¶ ALERTA CR√çTICO FINANCEIRO üè¶

            Taxa de falhas em transa√ß√µes est√° em {{ $value | humanizePercentage }}.
            Isso pode impactar diretamente a receita e a experi√™ncia do usu√°rio.
          business_impact: "Perda potencial de receita e insatisfa√ß√£o do cliente"
          recommended_actions: |
            1. Verificar logs de erro nas transa√ß√µes
            2. Validar conex√£o com banco de dados
            3. Verificar se h√° problemas de valida√ß√£o
            4. Contatar equipe de produto se persistir
          runbook_url: "https://wiki.fintelli.com/runbooks/transaction-failures"

      - alert: UnusualTransactionVolume
        expr: |
          abs(
            rate(transactions_created_total[5m]) - 
            rate(transactions_created_total[5m] offset 1h)
          ) > 0.5
        for: 5m
        labels:
          severity: warning
          service: fintelli-backend
          category: business
          business_impact: medium
        annotations:
          summary: "Volume de transa√ß√µes incomum detectado"
          description: |
            Volume de transa√ß√µes mudou significativamente comparado a 1h atr√°s.
            Atual: {{ $value | humanize }} transa√ß√µes/min

            Pode indicar:
            - Pico de uso leg√≠timo
            - Problema no sistema
            - Atividade suspeita
          business_impact: "Poss√≠vel impacto na capacidade ou seguran√ßa"

      - alert: LargeTransactionAnomaly
        expr: |
          increase(transaction_amount_bucket{le="10000"}[5m]) == 0 AND 
          increase(transaction_amount_bucket[5m]) > 0
        for: 1m
        labels:
          severity: warning
          service: fintelli-backend
          category: business
          business_impact: high
        annotations:
          summary: "Transa√ß√µes de valores muito altos detectadas"
          description: |
            üí∞ Transa√ß√µes com valores acima de R$ 10.000 foram detectadas.

            A√ß√µes recomendadas:
            - Verificar se s√£o transa√ß√µes leg√≠timas
            - Revisar controles de compliance
            - Validar limites de transa√ß√£o
          business_impact: "Risco de compliance e seguran√ßa financeira"

  # ==========================================
  # ALERTAS DE SEGURAN√áA FINTECH
  # ==========================================
  - name: fintelli-security-alerts
    rules:
      - alert: SuspiciousAPIActivity
        expr: |
          rate(calls_total{service_name="fintelli-backend"}[1m]) > 50
        for: 30s
        labels:
          severity: warning
          service: fintelli-backend
          category: security
          security_impact: medium
        annotations:
          summary: "Atividade suspeita de API detectada ({{ $value | humanize }} req/s)"
          description: |
            üîí ALERTA DE SEGURAN√áA üîí

            Taxa de requisi√ß√µes muito alta: {{ $value | humanize }} req/s
            Pode indicar:
            - Ataque DDoS
            - Bot automatizado
            - Tentativa de explora√ß√£o
          action_required: |
            1. Analisar logs de acesso
            2. Verificar IPs de origem
            3. Considerar ativar rate limiting
            4. Monitorar patterns de acesso

      - alert: AuthenticationAnomalies
        expr: |
          rate(calls_total{http_status_code="401"}[5m]) > 1
        for: 2m
        labels:
          severity: warning
          service: fintelli-backend
          category: security
          security_impact: high
        annotations:
          summary: "Taxa alta de falhas de autentica√ß√£o"
          description: |
            üö® POSS√çVEL TENTATIVA DE INVAS√ÉO üö®

            M√∫ltiplas tentativas de acesso n√£o autorizado detectadas.
            Taxa: {{ $value | humanize }} tentativas/s

            Pode indicar:
            - Ataque de for√ßa bruta
            - Credenciais comprometidas
            - Erro de configura√ß√£o
          action_required: |
            1. Verificar logs de autentica√ß√£o
            2. Analisar IPs suspeitos
            3. Considerar bloqueio tempor√°rio
            4. Notificar equipe de seguran√ßa

      - alert: DataBreachIndicators
        expr: |
          rate(calls_total{http_route=~".*user.*|.*account.*|.*profile.*", http_status_code="403"}[5m]) > 0.5
        for: 1m
        labels:
          severity: critical
          service: fintelli-backend
          category: security
          security_impact: critical
        annotations:
          summary: "Poss√≠veis indicadores de viola√ß√£o de dados"
          description: |
            üö® ALERTA CR√çTICO DE SEGURAN√áA üö®

            Tentativas de acesso n√£o autorizado a dados sens√≠veis detectadas.

            A√á√ÉO IMEDIATA REQUERIDA:
            1. Investigar logs imediatamente
            2. Verificar integridade dos dados
            3. Ativar protocolo de incident response
            4. Considerar notifica√ß√£o regulat√≥ria se confirmado

  # ==========================================
  # ALERTAS DE INFRAESTRUTURA CR√çTICA
  # ==========================================
  - name: fintelli-infrastructure-alerts
    rules:
      - alert: DatabaseConnectionExhaustion
        expr: |
          active_db_connections > 80
        for: 2m
        labels:
          severity: critical
          service: postgres
          category: infrastructure
          business_impact: critical
        annotations:
          summary: "Pool de conex√µes do banco quase esgotado ({{ $value }})"
          description: |
            üóÑÔ∏è CONEX√ïES DE BANCO CR√çTICAS üóÑÔ∏è

            N√∫mero de conex√µes ativas: {{ $value }}
            Limite t√≠pico: ~100 conex√µes

            Risco de:
            - Rejei√ß√£o de novas transa√ß√µes
            - Timeout de opera√ß√µes
            - Indisponibilidade do sistema
          recommended_actions: |
            1. Investigar connection leaks
            2. Verificar queries de longa dura√ß√£o
            3. Considerar aumentar pool temporariamente
            4. Analisar padr√µes de acesso

      - alert: CacheMemoryHigh
        expr: |
          redis_memory_used_bytes / redis_memory_max_bytes * 100 > 90
        for: 3m
        labels:
          severity: warning
          service: redis
          category: infrastructure
          business_impact: medium
        annotations:
          summary: "Uso de mem√≥ria do Redis muito alto ({{ $value | humanizePercentage }})"
          description: |
            üíæ MEM√ìRIA DO CACHE ALTA üíæ

            Uso atual: {{ $value | humanizePercentage }}

            Pode causar:
            - Lentid√£o nas opera√ß√µes
            - Eviction de dados importantes
            - Falhas de cache
          recommended_actions: |
            1. Analisar keys com TTL expirado
            2. Verificar tamanho de objetos grandes
            3. Considerar limpeza manual
            4. Planejar aumento de mem√≥ria

      - alert: DiskSpaceRunningOut
        expr: |
          (node_filesystem_avail_bytes{mountpoint="/"} / node_filesystem_size_bytes{mountpoint="/"}) * 100 < 20
        for: 5m
        labels:
          severity: critical
          service: host
          category: infrastructure
          business_impact: critical
        annotations:
          summary: "Espa√ßo em disco criticamente baixo ({{ $value | humanizePercentage }} livre)"
          description: |
            üíø ESPA√áO EM DISCO CR√çTICO üíø

            Espa√ßo livre: {{ $value | humanizePercentage }}

            A√á√ÉO URGENTE:
            - Sistema pode parar de funcionar
            - Logs podem parar de ser escritos
            - Banco de dados pode corromper

  # ==========================================
  # ALERTAS DE COMPLIANCE E AUDITORIA
  # ==========================================
  - name: fintelli-compliance-alerts
    rules:
      - alert: AuditLogFailure
        expr: |
          absent_over_time(up{job="audit-logs"}[5m])
        for: 1m
        labels:
          severity: critical
          service: audit-system
          category: compliance
          compliance_impact: critical
        annotations:
          summary: "Sistema de auditoria indispon√≠vel"
          description: |
            üìã FALHA CR√çTICA DE AUDITORIA üìã

            Sistema de logs de auditoria n√£o est√° respondendo.

            IMPACTO REGULAT√ìRIO:
            - Viola√ß√£o de requisitos de compliance
            - Risco de multas regulat√≥rias
            - Problemas em auditoria externa

            A√á√ÉO IMEDIATA:
            1. Restaurar sistema de auditoria
            2. Verificar integridade dos logs
            3. Documentar per√≠odo de indisponibilidade
            4. Notificar compliance officer

      - alert: SuspiciousTransactionPattern
        expr: |
          (
            rate(transactions_created_total{type="expense"}[10m]) /
            rate(transactions_created_total[10m])
          ) * 100 > 80
        for: 5m
        labels:
          severity: warning
          service: fintelli-backend
          category: compliance
          compliance_impact: medium
        annotations:
          summary: "Padr√£o suspeito: alta concentra√ß√£o de despesas"
          description: |
            üïµÔ∏è PADR√ÉO TRANSACIONAL SUSPEITO üïµÔ∏è

            {{ $value | humanizePercentage }} das transa√ß√µes s√£o despesas.

            Pode indicar:
            - Lavagem de dinheiro
            - Uso indevido da plataforma
            - Erro no sistema

            Requer investiga√ß√£o manual.

  # ==========================================
  # RECORDING RULES APRIMORADAS
  # ==========================================
  - name: fintelli-slos-recording-rules
    rules:
      # SLO de disponibilidade (99.9% em 30 dias)
      - record: fintelli:availability_30d
        expr: |
          (
            1 - (
              increase(calls_total{service_name="fintelli-backend",status_code=~"5.."}[30d]) /
              increase(calls_total{service_name="fintelli-backend"}[30d])
            )
          ) * 100

      # SLO de lat√™ncia (95% das requisi√ß√µes < 500ms)
      - record: fintelli:latency_slo_30d
        expr: |
          (
            increase(duration_bucket{service_name="fintelli-backend",le="0.5"}[30d]) /
            increase(duration_bucket{service_name="fintelli-backend",le="+Inf"}[30d])
          ) * 100

      # Taxa de sucesso em transa√ß√µes de neg√≥cio
      - record: fintelli:transaction_success_rate_24h
        expr: |
          (
            increase(transactions_created_total[24h]) /
            increase(calls_total{http_route="/api/transactions",http_method="POST"}[24h])
          ) * 100

      # Volume financeiro processado por hora
      - record: fintelli:financial_volume_1h
        expr: |
          sum(increase(transaction_amount[1h]))

      # Receita vs Despesas (√∫ltimas 24h)
      - record: fintelli:revenue_ratio_24h
        expr: |
          (
            sum(increase(transaction_amount{type="income"}[24h])) /
            abs(sum(increase(transaction_amount{type="expense"}[24h])))
          )
