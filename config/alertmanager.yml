# Configura√ß√£o do Alertmanager para Fintelli
# Arquivo: config/alertmanager.yml

global:
  smtp_smarthost: "localhost:587"
  smtp_from: "alertmanager@fintelli.com"
  smtp_auth_username: "alertmanager@fintelli.com"
  smtp_auth_password: "password"

# Configura√ß√£o de templates customizados
templates:
  - "/etc/alertmanager/templates/*.tmpl"

# Rota principal para processamento de alertas
route:
  group_by: ["alertname", "service", "severity"]
  group_wait: 10s # Tempo para aguardar alertas similares
  group_interval: 10s # Tempo entre reenvios do mesmo grupo
  repeat_interval: 1h # Tempo para repetir alertas n√£o resolvidos
  receiver: "default-receiver"

  # Rotas espec√≠ficas por severidade e tipo
  routes:
    # Alertas cr√≠ticos - notifica√ß√£o imediata
    - match:
        severity: critical
      receiver: "critical-alerts"
      group_wait: 0s
      repeat_interval: 15m

    # Alertas de SLA - equipe de produto
    - match:
        sla_impact: critical
      receiver: "sla-alerts"
      group_wait: 30s
      repeat_interval: 30m

    # Alertas de seguran√ßa - equipe de seguran√ßa
    - match:
        category: security
      receiver: "security-alerts"
      group_wait: 0s
      repeat_interval: 5m

    # Alertas de infraestrutura - equipe de infra
    - match_re:
        service: "(postgres|redis|nginx)"
      receiver: "infra-alerts"

    # Alertas de neg√≥cio/financeiros - equipe de produto
    - match:
        category: business
      receiver: "business-alerts"
      group_wait: 1m
      repeat_interval: 2h

# Inibi√ß√£o de alertas redundantes
inhibit_rules:
  # Se cr√≠tico est√° ativo, silencia warnings do mesmo servi√ßo
  - source_match:
      severity: "critical"
    target_match:
      severity: "warning"
    equal: ["service", "alertname"]

  # Se sistema est√° down, silencia alertas de lat√™ncia
  - source_match:
      alertname: "ZeroThroughput"
    target_match_re:
      alertname: ".*Latency.*"
    equal: ["service"]

# Configura√ß√£o de receptores/notifica√ß√µes
receivers:
  # Receptor padr√£o - logs apenas
  - name: "default-receiver"
    webhook_configs:
      - url: "http://localhost:8080/webhook/default"
        send_resolved: true

  # Alertas cr√≠ticos - m√∫ltiplos canais
  - name: "critical-alerts"
    email_configs:
      - to: "sre-team@fintelli.com,on-call@fintelli.com"
        from: "alertmanager@fintelli.com"
        html: |
          üö® ALERTA CR√çTICO DETECTADO üö®<br><br>
          Servi√ßo: {{ .GroupLabels.service }}<br>
          Alerta: {{ .GroupLabels.alertname }}<br>
          Severidade: {{ .GroupLabels.severity }}<br><br>
          Detalhes:<br>
          {{ range .Alerts }}
          - {{ .Annotations.summary }}<br>
            Valor: {{ .ValueString }}<br>
            Desde: {{ .StartsAt.Format "2006-01-02 15:04:05" }}<br>
          {{ end }}<br>
          üîó Runbook: {{ .Alerts.0.Annotations.runbook_url }}<br>
          üìä Dashboard: {{ .Alerts.0.Annotations.dashboard_url }}

    slack_configs:
      - api_url: "https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK"
        channel: "#alerts-critical"
        title: "üö® Alerta Cr√≠tico - {{ .GroupLabels.service }}"
        text: "{{ range .Alerts }}{{ .Annotations.summary }}{{ end }}"
        color: "danger"

    webhook_configs:
      - url: "http://localhost:8080/webhook/critical"
        send_resolved: true

  # Alertas de SLA
  - name: "sla-alerts"
    email_configs:
      - to: "product-team@fintelli.com,management@fintelli.com"
        from: "alertmanager@fintelli.com"
        html: |
          ‚ö†Ô∏è VIOLA√á√ÉO DE SLA DETECTADA ‚ö†Ô∏è<br><br>
          Servi√ßo: {{ .GroupLabels.service }}<br>
          Impacto no SLA: {{ .GroupLabels.sla_impact }}<br><br>
          {{ range .Alerts }}
          - {{ .Annotations.summary }}<br>
            Descri√ß√£o: {{ .Annotations.description }}<br>
          {{ end }}

  # Alertas de seguran√ßa
  - name: "security-alerts"
    email_configs:
      - to: "security-team@fintelli.com,ciso@fintelli.com"
        from: "alertmanager@fintelli.com"
        html: |
          üõ°Ô∏è ALERTA DE SEGURAN√áA üõ°Ô∏è<br><br>
          Tipo: {{ .GroupLabels.alertname }}<br>
          Servi√ßo: {{ .GroupLabels.service }}<br><br>
          {{ range .Alerts }}
          Detalhes: {{ .Annotations.description }}<br>
          A√ß√£o requerida: {{ .Annotations.action_required }}<br>
          {{ end }}

  # Alertas de infraestrutura
  - name: "infra-alerts"
    email_configs:
      - to: "infra-team@fintelli.com"
        from: "alertmanager@fintelli.com"
        html: "üîß [INFRA] {{ .GroupLabels.service }} - {{ .GroupLabels.alertname }}"

  # Alertas de neg√≥cio
  - name: "business-alerts"
    email_configs:
      - to: "product-team@fintelli.com,business-team@fintelli.com"
        from: "alertmanager@fintelli.com"
        html: |
          üíº ALERTA DE NEG√ìCIO - FINTELLI üíº<br><br>
          {{ range .Alerts }}
          M√©trica: {{ .Labels.alertname }}<br>
          Impacto: {{ .Annotations.business_impact }}<br>
          Valor atual: {{ .ValueString }}<br><br>
          Descri√ß√£o: {{ .Annotations.description }}<br><br>
          A√ß√µes recomendadas: {{ .Annotations.recommended_actions }}<br>
          {{ end }}
